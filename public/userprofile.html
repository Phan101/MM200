<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
  </head>
  <body>
    <!----------- HTML-elements -------------->
    <a href="userlogin.html">Back</a>
    <button id="logOut">Logout</button>
    <h1>Your Profile</h1>
    <button id="changeUsername">Change Username</button>
    <button id="changePassword">Change Password</button>
    <button id="deleteUser">Delete User</button>
    <h3 id="txtResult"></h3>

    <hr />
    <div id="container">
    </div>

    <!------------- JavaScript --------------->
    <script>
      let container = document.getElementById("container");
      let txtResult = document.getElementById("txtResult");
      let changeUsername = [];

      //validateUser();

      
      document.getElementById("changeUsername").addEventListener("click", async function(evt){

        let url = "/users";
        let token = localStorage.getItem("token")
        let cfg = {
            method: "GET",
            headers: {"authorization":token}
        }
        try {
            let response = await fetch(url,cfg);
            let data = await response.json();

            if(response.status != 200){
               throw data.error;
            }
   

            container.innerHTML = ""; //delete previous content


            let profileDiv = document.createElement("div");

            profileDiv.innerHTML = "<h2><b>Change Username:</b></h2>";
            profileDiv.innerHTML += "<h3>Type in your old username</h3>";
            profileDiv.innerHTML += "<input id='inpUsername' type='text' placeholder='Old Username'/><br>";
            profileDiv.innerHTML += "<h3>Type in your password</h3>";
            profileDiv.innerHTML += "<input id='inpPassword' type='text' placeholder='Password'/><br><br>";
            container.appendChild(profileDiv);
                  let inpUsername = document.getElementById("inpUsername");
                  let inpPassword = document.getElementById("inpPassword");
                //new item button
                let changeBtn = document.createElement("button");
                let btnStates = {clicked: false};
                changeBtn.innerHTML = "Change";
                profileDiv.appendChild(changeBtn);


                changeBtn.addEventListener("click", async function(evt){
                  let url = "/users/login";
                  let credString = createCredentialString(inpUsername.value, inpPassword.value)
            
                   let cfg = {
                        method: "POST",
                       headers: {"authorization":credString}
                    }

                    let allUsers = [];
                    for(value of data){
                      allUsers.push(value);
                    }

                   try{
                        let response = await fetch(url, cfg);
                        let data = await response.json();

                        if(response.status != 200){
                            throw data.error;
                       }
                       //container.innerHTML = ""; //delete previous content
                       profileDiv.innerHTML += "<h3>Type in your new username</h3>";
                       profileDiv.innerHTML += "<input id='newUsername' type='text' placeholder='New Username'/><br><br>";

                       let changeBtn = document.createElement("button");
                       let btnStates = {clicked: false};
                       changeBtn.innerHTML = "Change";
                       profileDiv.appendChild(changeBtn);


                       let newUsername = document.getElementById("newUsername");
                       changeBtn.addEventListener("click", async function(evt){
                         
                        changeUsername = [];
                        changeUsername.push(newUsername.value);
                        for(let i=0; i< allUsers.length; i++){
                          if (allUsers[i].username===inpUsername.value){
                            changeUsername.push(allUsers[i].id);
                          }
                        }
                         console.log(changeUsername);
                         editUsername();
                       });
                   }
                   catch(err){
                       console.log(err);
                        txtResult.innerHTML = "Something went wrong - check the console window";
                
                    }
                });
        }
        catch(error) {
            console.log(error);
        }
        });

        async function editUsername(){
            let url = "/changeusername";
            let token = localStorage.getItem("token")
            let updata = {
                dbTable: "users",
                dbCol: "username",
                newDbText: changeUsername[0],
                dbID: "id",
                id: changeUsername[1],
            }

            let cfg = {
                method: "POST",
                headers: {
                    "content-type":"application/json",
                    "authorization":token
                },
                body: JSON.stringify(updata)
            }
            try{
                let response = await fetch(url, cfg);
                let data = await response.json();

                if(response.status != 200){
                    throw data.error
                }

            }
            catch(error){
                console.log(error);
            }     
        };



function createCredentialString(username,password){
            let combinedStr = `${username}:${password}`
            let b64Str = btoa(combinedStr);
            return `basic ${b64Str}`;
        }

      


      document.getElementById("changePassword").addEventListener("click", function (evt) {});

      document.getElementById("deleteUser").addEventListener("click", function (evt) {});

      document.getElementById("logOut").addEventListener("click", function(evt){
        localStorage.clear();
        window.location.href = "/userlogin.html";
    });


    </script>

    <!---------------- CSS ------------------->
    <style></style>
  </body>
</html>
