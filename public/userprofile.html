<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <script src="js/security.js"></script>
  </head>
  <body>
    <!----------- HTML-elements -------------->
    <a href="userlogin.html">Back</a>
    <button id="logOut">Logout</button>
    <h1>Your Profile</h1>
    <button id="changeUsername">Change Username</button>
    <button id="changePassword">Change Password</button>
    <button id="deleteUser">Delete User</button>
    <h3 id="txtResult"></h3>

    <hr />
    <div id="container"></div>

    <!------------- JavaScript --------------->
    <script>
      let container = document.getElementById("container");
      let txtResult = document.getElementById("txtResult");
      let changeUsername = [];
      let deleteUsername = [];

      getUsers();
      async function getUsers() {
        let url = "/users";
        let token = localStorage.getItem("token");
        let cfg = {
          method: "GET",
          headers: { authorization: token },
        };
        try {
          let response = await fetch(url, cfg);
          let data = await response.json();

          if (response.status != 200) {
            throw data.error;
          }
          let allUsers = [];
          for (value of data) {
            allUsers.push(value);
          }
        } catch (error) {
          console.log(error);
        }
      }

      document
        .getElementById("changeUsername")
        .addEventListener("click", async function (evt) {
          let url = "/users";
          let token = localStorage.getItem("token");
          let cfg = {
            method: "GET",
            headers: { authorization: token },
          };
          try {
            let response = await fetch(url, cfg);
            let data = await response.json();

            if (response.status != 200) {
              throw data.error;
            }

            container.innerHTML = ""; //delete previous content

            let profileDiv = document.createElement("div");

            profileDiv.innerHTML = `<h2><b>Change Username:</b></h2>
                  <h3>Type in your old username</h3>
                  <input id='inpUsername' type='text' placeholder='Old Username'/><br>
                  <h3>Type in your password</h3>
                  <input id='inpPassword' type='text' placeholder='Password'/><br><br>`;
            container.appendChild(profileDiv);
            let inpUsername = document.getElementById("inpUsername");
            let inpPassword = document.getElementById("inpPassword");
            //new item button
            let changeBtn = document.createElement("button");
            let btnStates = { clicked: false };
            changeBtn.innerHTML = "Change";
            profileDiv.appendChild(changeBtn);

            changeBtn.addEventListener("click", async function (evt) {
              let url = "/users/login";
              let credString = createCredentialString(
                inpUsername.value,
                inpPassword.value
              );

              let cfg = {
                method: "POST",
                headers: { authorization: credString },
              };

              let allUsers = [];
              for (value of data) {
                allUsers.push(value);
              }

              try {
                let response = await fetch(url, cfg);
                let data = await response.json();

                if (response.status != 200) {
                  throw data.error;
                }
                //container.innerHTML = ""; //delete previous content
                profileDiv.innerHTML += "<h3>Type in your new username</h3>";
                profileDiv.innerHTML +=
                  "<input id='newUsername' type='text' placeholder='New Username'/><br><br>";

                let changeBtn = document.createElement("button");
                let btnStates = { clicked: false };
                changeBtn.innerHTML = "Change";
                profileDiv.appendChild(changeBtn);

                let newUsername = document.getElementById("newUsername");
                changeBtn.addEventListener("click", async function (evt) {
                  changeUsername = { value: "", id: "" };
                  changeUsername.value = newUsername.value;
                  for (let i = 0; i < allUsers.length; i++) {
                    if (allUsers[i].username === inpUsername.value) {
                      changeUsername.id = allUsers[i].id;
                    }
                  }
                  console.log(changeUsername);
                  editUsername();
                });
              } catch (err) {
                console.log(err);
                txtResult.innerHTML =
                  "Something went wrong - check the console window";
              }
            });
          } catch (error) {
            console.log(error);
          }
        });

      async function editUsername() {
        let url = "/changeusername";
        let token = localStorage.getItem("token");
        let updata = {
          dbTable: "users",
          dbCol: "username",
          newDbText: changeUsername.value,
          dbID: "id",
          id: changeUsername.id,
        };

        let cfg = {
          method: "POST",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };
        try {
          let response = await fetch(url, cfg);
          let data = await response.json();

          if (response.status != 200) {
            throw data.error;
          }
        } catch (error) {
          console.log(error);
        }
      }

      document
        .getElementById("deleteUser")
        .addEventListener("click", async function (evt) {
          container.innerHTML = ""; //delete previous content
          let profileDiv = document.createElement("div");

          profileDiv.innerHTML = `<h2><b>Are you sure you want to delete your account?<br>
                    All the lists connected to this account will also be deleted:</b></h2>
                  <h3>Type in your Username</h3>
                  <input id='inpUsername' type='text' placeholder='Username'/><br>
                  <h3>Type in your password</h3>
                  <input id='inpPassword' type='text' placeholder='Password'/><br>
                  <h3>Confirm your password</h3>
                  <input id='inpPasswordConfirm' type='text' placeholder='Confirm Password'/><br><br>`;
          container.appendChild(profileDiv);
          let inpPassword = document.getElementById("inpPassword");
          let inpPasswordConfirm =
            document.getElementById("inpPasswordConfirm");
          let changeBtn = document.createElement("button");
          changeBtn.innerHTML = "Delete";
          profileDiv.appendChild(changeBtn);

          changeBtn.addEventListener("click", async function (evt) {
            let credString = createCredentialString(inpUsername.value, inpPassword.value)
            let url = "/users";
            let token = localStorage.getItem("token");
            let cfg = {
              method: "GET",
              headers: { authorization: token },
            };
            try {
              let response = await fetch(url, cfg);
              let data = await response.json();
              let allUsers = [];
              for (value of data) {
                allUsers.push(value);
              };
              console.log(allUsers);
              let testCredString = createCredentialString(allUsers[11].username,allUsers[11].password);
              console.log(testCredString);
              console.log(credString);
              for (let i = 0; i < allUsers.length; i++) {
                    if (allUsers[i].username === inpUsername.value) {
                      deleteUsername.push(allUsers[i].username);
                    }
                  };
              

              if (response.status != 200) {
                throw data.error;
              }
            } catch (error) {
              console.log(error);
            }
            if (inpPassword.value == inpPasswordConfirm.value && inpPassword.value) {
              
               deleteUser(deleteUsername[0]);
            } else {
              console.log("må huske å legge inn feilmelding :D");
            }
          });
        });

      async function deleteUser(listItemID) {
        let url = "/deleteuser";
        let token = localStorage.getItem("token");

        let updata = {
          dbTable: "users",
          dbCol: "username",
          id: listItemID,
        };

        let cfg = {
          method: "DELETE",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };

        try {
          let response = await fetch(url, cfg);
          let data = await response.json();

          if (response.status != 200) {
            throw data.error;
          }

        } catch (error) {
          console.log(error);
        }
      }

      document
        .getElementById("changePassword")
        .addEventListener("click", function (evt) {});

      document
        .getElementById("logOut")
        .addEventListener("click", function (evt) {
          localStorage.clear();
          window.location.href = "/userlogin.html";
        });

      function createCredentialString(username, password) {
        let combinedStr = `${username}:${password}`;
        let b64Str = btoa(combinedStr);
        return `basic ${b64Str}`;
      }
    </script>

    <!---------------- CSS ------------------->
    <style></style>
  </body>
</html>
