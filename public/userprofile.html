<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <script src="js/security.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/stylesheet.css">
  </head>
  <body>
    <!----------- HTML-elements -------------->
    <a href="mylist.html">Back</a>
    <button id="logOut">Logout</button>
    <p id="userProfile" style="font-size:200%""></p>
    <button id="changeUsername">Change Username</button>
    <button id="changePassword">Change Password</button>
    <button id="deleteUser">Delete</button>

    <hr/>
    <div id="container"></div>

    <div id="profileDiv">
      <h2><b>Change Username:</b></h2>
      <h3>Type in your old username</h3>
        <input id='inpUsername' type='text' placeholder='Old Username'/><br>
      <h3>Type in your password</h3>
        <input id='inpPassword' type='password' placeholder='Password'/><input type="checkbox" onclick="showPw()">Show password<br><br>
        <button id="changeBtn">Change username</button>
    </div>
    <div id="changePasswordDiv">
      <h2><b>Change Password:</b></h2>
                  <h3>Type in your username</h3>
                  <input id='inpUsername2' type='text' placeholder='Username'/><br>
                  <h3>Type in your old password</h3>
                  <input id='inpPassword2' type='text' placeholder='Old Password'/><br><br>
                  <button id="verifyBtn">Change Password</button>
    </div>
    <h3 id="txtResult"></h3>
    <!------------- JavaScript --------------->
    <script>
      let container = document.getElementById("container");
      let txtResult = document.getElementById("txtResult");
      let inpUsername = document.getElementById("inpUsername");
      let inpPassword = document.getElementById("inpPassword");

      let inpUsername2 = document.getElementById("inpUsername2");
      let inpPassword2 = document.getElementById("inpPassword2");

      let changeBtn = document.getElementById("changeBtn"); // Change username
      let verifyBtn = document.getElementById("verifyBtn"); // Change password
      let profileDiv = document.getElementById("profileDiv");
      let changePasswordDiv = document.getElementById("changePasswordDiv");
  
      loadScreen(localStorage.idAuth);
      async function loadScreen(id){
        let url = "/getuser";
        let token = localStorage.getItem("token");
        let updata = {
          userId: id,
        };

        let cfg = {
          method: "POST",
          headers: {
            "content-type": "application/json",
            authorization: token,
            userId: id,
          },
          body: JSON.stringify(updata),
        };
          try {
            let response = await fetch(url, cfg);
            let data = await response.json();

            if (response.status != 200) {
              throw data.error;
            }

              let userProfile = document.getElementById("userProfile");
              userProfile.innerHTML = `Welcome to your profile, <b>${data[0].username}</b>.`;
      } catch (error) {
            console.log(error);
          }
        }

        //Change Username

      document.getElementById("changeUsername").addEventListener("click", async function (evt) {
        let url = "/getuser";
        let token = localStorage.getItem("token");
        let updata = {
          userId: localStorage.idAuth,
        };

        let cfg = {
          method: "POST",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };
          try {
            let response = await fetch(url, cfg);
            let data = await response.json();

            if (response.status != 200) {
              throw data.error;
            }
          let loginUsername = data[0].username;

            showProfileDiv();

            changeBtn.addEventListener("click", async function (evt) {
              let url = "/users/login";
              let credString = createCredentialString(
                inpUsername.value,
                inpPassword.value
              );

              let cfg = {
                method: "POST",
                headers: { authorization: credString },
              };

              try {
                let response = await fetch(url, cfg);
                let data = await response.json();

                if(loginUsername != inpUsername.value){
                  throw "Invalid username and/or password";
                }
                
                if (response.status != 200) {
                  throw data.error;
                }
                
                profileDiv.innerHTML = "<h3>Type in your new username</h3>";
                profileDiv.innerHTML +=
                  "<input id='newUsername' type='text' placeholder='New Username'/><br><br>";

                let changeUsernameBtn = document.createElement("button");
                changeUsernameBtn.innerHTML = "Change";
                profileDiv.appendChild(changeUsernameBtn);

                changeUsernameBtn.addEventListener("click", async function (evt) {
                  txtResult.innerHTML = "";
                  let newUsername = document.getElementById("newUsername");
                  
                  editUsername(newUsername.value, localStorage.idAuth);
                  
                });
              } catch (err) {
                txtResult.innerHTML = err;
              }
            });
          } catch (error) {
          }
        });

      async function editUsername(newText, userId) {
        let url = "/changeuserinfo";
        let token = localStorage.getItem("token");
        let updata = {
          dbTable: "users",
          dbCol: "username",
          newDbText: newText,
          dbID: "id",
          id: userId,
        };

        let cfg = {
          method: "POST",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };
        try {
          let response = await fetch(url, cfg);
          let data = await response.json();

          if (response.status !== 200) {
            throw data.error;
          }
        } catch (error) {
          txtResult.innerHTML = error;

        }
        if(txtResult.innerHTML == ""){
          location.reload(); // Refresher for Ã¥ gi nye profilnavnet
      }
    }

      // -- END CHANGE USERNAME

      // ----- Delete user
      document.getElementById("deleteUser").addEventListener("click", confirmDelete);
      function confirmDelete(){
        let confirmUserDelete = confirm("Are you sure you want to delete user?");
        if(confirmUserDelete){
          deleteUser(localStorage.getItem("idAuth"));
          localStorage.clear();
          window.location.href = "/index.html";
        }
      }

      async function deleteUser(listItemID) {
        let url = "/deleteuser";
        let token = localStorage.getItem("token");

        let updata = {
          dbTable: "users",
          dbCol: "id",
          id: listItemID,
        };

        let cfg = {
          method: "DELETE",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };

        try {
          let response = await fetch(url, cfg);
          let data = await response.json();

          if (response.status !== 200) {
            throw data.error;
          }

        } catch (error) {
          console.log(error);
        }
      }

       
      document.getElementById("changePassword").addEventListener("click", async function (evt) {
        let url = "/getuser";
        let token = localStorage.getItem("token");
        let updata = {
          userId: localStorage.idAuth,
        };

        let cfg = {
          method: "POST",
          headers: {
            "content-type": "application/json",
            authorization: token,
          },
          body: JSON.stringify(updata),
        };
          try {
            let response = await fetch(url, cfg);
            let data = await response.json();

            let inpId = data[0].id;
            let salt = data[0].salt;
            let username = data[0].username;

            if (response.status != 200) {
              throw data.error;
            }
            showChangePasswordDiv();
            verifyBtn.addEventListener("click", async function (evt) {
              txtResult.innerHTML = "";
              let url = "/users/login";
              let credString = createCredentialString(
                inpUsername2.value,
                inpPassword2.value
              );

              let cfg = {
                method: "POST",
                headers: { authorization: credString },
              };
              try {
                let response = await fetch(url, cfg);
                let data = await response.json();
                if (response.status != 200) {
                  throw data.error;
                }

                if(inpId != localStorage.idAuth){
                  console.log("feil")
                  throw "Invalid username and/or password";
                }
                changePasswordDiv.innerHTML = "<h3>Type in your new password</h3>";
                changePasswordDiv.innerHTML += "<input id='newPassword' type='text' placeholder='New Password'/><br><br>";

                let changePWBtn = document.createElement("button");
                changePWBtn.innerHTML = "Update password";
                changePasswordDiv.appendChild(changePWBtn);

                changePWBtn.addEventListener("click", async function (evt) {
                  let newPassword = document.getElementById("newPassword");
                  newPassword = newPassword.value;
                  updatePassword(username, newPassword, salt, inpId);
                });
                
              } catch (error) {
            txtResult.innerHTML = error;
          }
      });
    } catch (error) {
          console.log(error);
        }
    });

    async function updatePassword(username, password, salt, inpId){
      let url = "/updatepassword";
            let credString = createCredentialString(username, password)

            let updata = {
            dbSalt: salt,
            dbTable: "users",
            dbCol: "password",
            inpId: inpId,
            dbID: "id",
        }; 
            
            let cfg = {
                method: "POST",
                headers: {
                    "content-type":"application/json",
                    "authorization":credString
                },
                body: JSON.stringify(updata)
            }

            try{
                let response = await fetch(url, cfg);
                let data = await response.json();

                if(response.status !== 200){
                    throw data.error;
                }
                txtResult.innerHTML = data.msg
            }
            catch(err){
                console.log(err);
                txtResult.innerHTML = "Something went wrong - check the console window";
            }
        };
          

      document
        .getElementById("logOut")
        .addEventListener("click", function (evt) {
          localStorage.clear();
          window.location.href = "/index.html";
        });

      function showProfileDiv(){
        txtResult.innerHTML = "";
        if(profileDiv.style.display === "block"){
          profileDiv.style.display = "none";
        } else {
          profileDiv.style.display = "block";
          changePasswordDiv.style.display = "none";
        }
      }

      function showChangePasswordDiv(){
        txtResult.innerHTML = "";
        if(changePasswordDiv.style.display === "block"){
          changePasswordDiv.style.display = "none";
        } else {
          changePasswordDiv.style.display = "block";
          profileDiv.style.display = "none";
        }
      }

      // Show password checkbox
      function showPw(){
            if(inpPassword.type === "password"){
                inpPassword.type = "text";
            } else {
                inpPassword.type = "password";
            }
        }

      // Credentials
      function createCredentialString(username, password) {
        let combinedStr = `${username}:${password}`;
        let b64Str = btoa(combinedStr);
        return `basic ${b64Str}`;
      }
    </script>

    <!---------------- CSS ------------------->
    <style></style>
  </body>
</html>